<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <style>
      input[type="checkbox"] {
        box-shadow: none !important;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <nav class="bg-gray-900 shadow">
      <div
        class="max-w-screen-xl flex items-center justify-between mx-auto p-5"
      >
        <!-- Logo, displayed only on md and larger screens -->
        <a
          href="index.html"
          class="hidden md:flex items-center space-x-3 rtl:space-x-reverse"
        >
          <img
            src="https://flowbite.com/docs/images/logo.svg"
            class="h-8"
            alt="Flowbite Logo"
          />
          <span
            class="self-center text-2xl font-semibold whitespace-nowrap text-white"
            >E-commerce</span
          >
        </a>

        <!-- Centered Full-width Search Bar -->
        <div class="flex-1 flex justify-center pe-5">
          <div class="relative w-full max-w-lg">
            <div
              class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"
            >
              <svg
                class="w-4 h-4 text-gray-400"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 20 20"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"
                />
              </svg>
              <span class="sr-only">Search icon</span>
            </div>
            <input
              type="text"
              id="search-navbar"
              class="block w-full p-2 ps-10 text-sm border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-700 border-gray-600 placeholder-gray-400 text-white"
              placeholder="Search..."
            />
          </div>
        </div>

        <!-- Right Side: Cart and User Profile -->
        <div
          class="flex items-center space-x-5 md:space-x-10 rtl:space-x-reverse"
        >
          <!-- Favorite Icon -->
          <a
            href="favorite.html"
            class="text-gray-400 hover:text-white focus:outline-none"
            aria-label="View favorite"
          >
            <i class="fa-solid fa-heart text-xl"></i>
          </a>
          <!-- Shopping Cart Icon -->
          <a
            href="cart.html"
            class="text-gray-400 hover:text-white focus:outline-none"
            aria-label="View cart"
          >
            <i class="fas fa-shopping-cart text-xl"></i>
          </a>

          <!-- User Profile Icon and Dropdown Menu -->
          <button
            type="button"
            class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-600"
            id="user-menu-button"
            aria-expanded="false"
            data-dropdown-toggle="user-dropdown"
            data-dropdown-placement="bottom"
          >
            <span class="sr-only">Open user menu</span>
            <img
              class="w-8 h-8 rounded-full"
              src="https://static.vecteezy.com/system/resources/thumbnails/019/900/306/small_2x/happy-young-cute-illustration-face-profile-png.png"
              alt="user photo"
            />
          </button>

          <!-- Dropdown menu -->
          <div
            class="z-50 hidden my-4 text-base list-none divide-y rounded-lg shadow bg-gray-700 divide-gray-600"
            id="user-dropdown"
          >
            <div class="px-4 py-3">
              <span class="name block text-sm text-white"></span>
              <span class="email block text-sm truncate text-gray-400"></span>
            </div>
            <ul class="py-2" aria-labelledby="user-menu-button">
              <li>
                <a
                  href="OrderHistory.html"
                  class="block px-4 py-2 text-sm hover:bg-gray-600 text-gray-200 hover:text-white"
                  >Order History</a
                >
              </li>
              <li>
                <a
                  href="logout.html"
                  class="block px-4 py-2 text-sm hover:bg-gray-600 font-bold text-red-500"
                  >Sign out</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-screen-xl flex mx-auto my-5 p-5">
      <div class="pe-5" style="width: 20%">
        <div class="flex items-center space-x-1">
          <svg
            class="w-5 h-5 text-gray-900"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-width="2.2"
              d="M18.796 4H5.204a1 1 0 0 0-.753 1.659l5.302 6.058a1 1 0 0 1 .247.659v4.874a.5.5 0 0 0 .2.4l3 2.25a.5.5 0 0 0 .8-.4v-7.124a1 1 0 0 1 .247-.659l5.302-6.059c.566-.646.106-1.658-.753-1.658Z"
            />
          </svg>

          <p class="text-xl font-bold">FILTER</p>
        </div>

        <p class="text-lg font-semibold mt-5 mb-2">Harga</p>
        <div class="flex items-center mb-4">
          <input
            id="radio-asc"
            type="radio"
            name="sort-order"
            value="asc"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 focus:ring-2"
          />
          <label
            for="radio-asc"
            class="ms-2 text-base font-normal text-gray-900"
            >Rendah ke Tinggi</label
          >
        </div>
        <div class="flex items-center mb-4">
          <input
            id="radio-desc"
            type="radio"
            name="sort-order"
            value="desc"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 focus:ring-2"
          />
          <label
            for="radio-desc"
            class="ms-2 text-base font-normal text-gray-900"
            >Tinggi ke Rendah</label
          >
        </div>

        <div
          class="flex items-center border border-gray-300 mb-4 rounded-lg overflow-hidden"
          style="height: 2.5rem"
        >
          <span
            class="text-gray-500 font-bold text-center"
            style="
              width: 3rem;
              height: 100%;
              background-color: #f3f4f5;
              display: flex;
              align-items: center;
              justify-content: center;
            "
            >Rp</span
          >
          <input
            type="number"
            placeholder="Harga Minimum"
            class="filter-minimum w-full border-0 focus:ring-0 focus:outline-none"
            min="0"
          />
        </div>

        <div
          class="flex items-center border border-gray-300 rounded-lg overflow-hidden"
          style="height: 2.5rem"
        >
          <span
            class="text-gray-500 font-bold text-center"
            style="
              width: 3rem;
              height: 100%;
              background-color: #f3f4f5;
              display: flex;
              align-items: center;
              justify-content: center;
            "
            >Rp</span
          >
          <input
            type="number"
            placeholder="Harga Maksimum"
            class="filter-maksimum w-full border-0 focus:ring-0 focus:outline-none"
            min="0"
          />
        </div>
        <hr
          class="mt-5 mb-2"
          style="border: none; border-top: 2px solid #ededed"
        />

        <p class="text-lg font-semibold mb-2">Kondisi</p>
        <div class="flex items-center mb-3">
          <input
            id="baru-radio"
            type="radio"
            name="product-condition"
            value="baru"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-full focus:ring-0 focus:outline-none shadow-none"
          />
          <label
            for="baru-radio"
            class="ms-2 text-base font-normal text-gray-900"
            >Baru</label
          >
        </div>

        <div class="flex items-center mb-3">
          <input
            id="bekas-radio"
            type="radio"
            name="product-condition"
            value="bekas"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-full focus:ring-0 focus:outline-none shadow-none"
          />
          <label
            for="bekas-radio"
            class="ms-2 text-base font-normal text-gray-900"
            >Bekas</label
          >
        </div>
      </div>
      <div style="width: 80%">
        <div
          class="products-container flex flex-wrap md:gap-2 max-w-screen-xl mx-auto mb-5"
        ></div>
      </div>
    </div>
    <script>
      window.onload = function () {
        const idUser = sessionStorage.getItem("id_user");
        const name = sessionStorage.getItem("name");
        const email = sessionStorage.getItem("email");

        if (!idUser) {
          // Jika tidak ada id_user, tampilkan alert dan arahkan ke login.html
          alert("Anda harus login terlebih dahulu.");
          window.location.href = "login.html";
        }
        document.querySelector(".name").innerHTML = name;
        document.querySelector(".email").innerHTML = email;
      };
      const params = new URLSearchParams(window.location.search);
      const searchQuery = params.get("search");
      const category = params.get("category");
      const apiUrl =
        "https://5wbr7sngsd.execute-api.us-east-1.amazonaws.com/default/rdslambda";

      let fetchedProducts = [];
      let currentSort = ""; // "asc" or "desc"

      // Fetch products data
      async function fetchProducts() {
        let url = apiUrl;

        if (searchQuery) {
          url += `?search=${encodeURIComponent(searchQuery)}`;
          document.title = `E-commerce | ${searchQuery}`;
        } else if (category) {
          url += `?category=${encodeURIComponent(category)}`;
          document.title = `E-commerce | ${category}`;
        } else {
          document.title = "E-commerce";
        }

        const condition = document.querySelector(
          'input[name="product-condition"]:checked'
        )?.value;
        if (condition) {
          url += url.includes("?")
            ? `&condition=${encodeURIComponent(condition)}`
            : `?condition=${encodeURIComponent(condition)}`;
        }

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Error: ${response.statusText}`);
          }
          fetchedProducts = await response.json();
          applyFilters(); // Apply all filters on first load
        } catch (error) {
          console.error("Error fetching products:", error);
        }
      }

      // Render products into DOM
      function renderProducts(products) {
        const container = document.querySelector(".products-container");
        container.innerHTML = ""; // Clear the container before adding new items

        if (products.length === 0) {
          container.innerHTML = "<p>No products found.</p>";
          return;
        }

        products.forEach((product) => {
          const productImageUrl = `https://ccecommerce.s3.us-east-1.amazonaws.com/img/${encodeURIComponent(
            product.name
          )}.jpg`;
          const productElement = `
    <a href="detail.html?name=${product.name}" class="block">
      <div class="flex flex-col mb-2 rounded-lg border-2 hover:border-red-500 transition-all" style="width: 15rem; height: 22rem">
        <div class="flex justify-center img-container" style="width: 100%; height: 12rem">
          <img src="${productImageUrl}" class="w-full h-full object-cover rounded-t-lg" alt="${
            product.name
          }" style="object-fit: cover"/>
        </div>
        <div class="mx-2 mb-1 mt-2" style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 2.4em;">
          <p class="text-sm font-medium text-gray-900 uppercase">${
            product.name
          }</p>
        </div>
        <div class="mx-2 my-1">
          <p class="text-lg font-bold text-gray-900">Rp${product.price.toLocaleString(
            "id-ID"
          )}</p>
        </div>
        <div class="flex items-center mx-1 mt-1 space-x-1">
          <svg class="w-[20px] h-[20px] text-yellow-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z"/>
          </svg>
          <p class="text-base font-normal text-gray-400">${product.rating}</p>
          <span class="text-gray-400">•</span>
          <p class="text-base font-normal text-gray-400">${
            product.sold
          } terjual</p>
        </div>
        <div class="flex items-center mx-1 mb-1 space-x-1">
          <svg class="w-[20px] h-[20px] text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.8 13.938h-.011a7 7 0 1 0-11.464.144h-.016l.14.171c.1.127.2.251.3.371L12 21l5.13-6.248c.194-.209.374-.429.54-.659l.13-.155Z"/>
          </svg>
          <p class="text-base font-normal text-gray-400">${product.location}</p>
        </div>
      </div>
    </a>
  `;
          container.insertAdjacentHTML("beforeend", productElement);
        });
      }

      // Apply sorting logic
      function sortProducts(products) {
        if (currentSort === "asc") {
          return products.sort((a, b) => a.price - b.price);
        } else if (currentSort === "desc") {
          return products.sort((a, b) => b.price - a.price);
        }
        return products;
      }

      // Apply price range filter
      function filterByPrice(products) {
        const minPrice =
          parseInt(document.querySelector(".filter-minimum").value) || 0;
        const maxPrice =
          parseInt(document.querySelector(".filter-maksimum").value) ||
          Infinity;

        return products.filter(
          (product) => product.price >= minPrice && product.price <= maxPrice
        );
      }

      // Apply condition filter (Baru/Bekas)
      function filterByCondition(products) {
        const condition = document.querySelector(
          'input[name="product-condition"]:checked'
        )?.value;
        if (condition) {
          return products.filter(
            (product) =>
              product.condition.toLowerCase() === condition.toLowerCase()
          );
        }
        return products; // If no condition selected, return all products
      }

      // Apply all filters
      function applyFilters() {
        let filteredProducts = fetchedProducts;

        // Apply price filter
        filteredProducts = filterByPrice(filteredProducts);

        // Apply condition filter
        filteredProducts = filterByCondition(filteredProducts);

        // Apply sorting filter
        filteredProducts = sortProducts(filteredProducts);

        // Render filtered products
        renderProducts(filteredProducts);
      }

      // Event listeners for the filters
      document.querySelectorAll('input[name="sort-order"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          currentSort = e.target.value;
          applyFilters();
        });
      });

      // Event listeners for price input
      document
        .querySelector(".filter-minimum")
        .addEventListener("input", applyFilters);
      document
        .querySelector(".filter-maksimum")
        .addEventListener("input", applyFilters);

      // Event listener for condition filter
      document
        .querySelectorAll('input[name="product-condition"]')
        .forEach((radio) => {
          radio.addEventListener("change", applyFilters); // Apply filters when condition is changed
        });

      // Initial fetch
      fetchProducts();

      document
        .getElementById("search-navbar")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const searchInput = document
              .getElementById("search-navbar")
              .value.trim();

            // Jika input pencarian tidak kosong, kita akan mengirimkan query ke items.html
            if (searchInput) {
              window.location.href = `items.html?search=${encodeURIComponent(
                searchInput
              )}`;
            }
          }
        });
    </script>
  </body>
</html>
